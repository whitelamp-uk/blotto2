<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>

    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"></meta>
    <link rel="icon" href="./media/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" href="./media/favicon.ico" type="image/x-icon" />

    <meta charset="utf-8" />
    <meta http-equiv="x-ua-compatible" content="ie=edge" />
    <meta name="description" content="" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link rel="author" href="http://www.thefundraisingfoundry.com/" />
    <title title="Lottery profit calculator by The Fundraising Foundry">Lottery profit calculator</title>

    <script>

function calculate ( ) {
    // Declare all internal variables and get it over with before doing anything else
    var campaignlength, limit, sales, cnli, cnl1, cnl4, cnl12, cnle, limit, totals=[], charge, profit, ppm, i, n;
    var tbody, slffnd, brkevn, slffnde, brkevne, invest=0, investe, yearse;
//    // Pre-existing balance
//    balance = 1 * document.querySelector ('[name="balance"]').value;
//    // Pre-existing tickets
//    tickets = 1 * document.querySelector ('[name="tickets"]').value;
//    // Ticket price
//    price   = 1 * document.querySelector ('[name="price"]').value;
//    // Draws per week
//    dpw     = 1 * document.querySelector ('[name="draws"]').value;
//    // Sign-up quantity
//    loaded  = 1 * document.querySelector ('[name="loaded"]').value;
//    // Cancellation rate immediately %
//    cnli    = 1 * document.querySelector ('[name="cancellation_i"]').value;
//    // Canvassing company charge per sign-up £
//    cost    = 1 * document.querySelector ('[name="cost"]').value;
//    // Canvassing company charge increase per annum £
//    inc     = 1 * document.querySelector ('[name="increase"]').value;
//    // Delay in weeks before payments
//    delay   = 1 * document.querySelector ('[name="delay"]').value;
//    // Profit from lottery revenue %
//    profit  = 1 * document.querySelector ('[name="profit"]').value;
//    // Cancellation rate except immediately %
//    cnla    = 1 * document.querySelector ('[name="cancellation_a"]').value;
//    // Refund rate % of cost
//    rfnd    = 0; //1 * document.querySelector ('[name="refund"]').value;
//    // Mean quantity of chances per sign-up
//    chances = document.querySelector ('[name="chances"]').value;

campaignlength = document.querySelector ('[name="campaignlength"]').value;
sales  = document.querySelector ('[name="sales"]').value;
charge = document.querySelector ('[name="charge"]').value;
profit = document.querySelector ('[name="profit"]').value;
cnli   = document.querySelector ('[name="cnli"]').value;
cnl1   = document.querySelector ('[name="cnl1"]').value;
cnl4   = document.querySelector ('[name="cnl4"]').value;
cnl12  = document.querySelector ('[name="cnl12"]').value;
cnle   = document.querySelector ('[name="cnle"]').value;
ppm    = document.querySelector ('[name="ppm"]').value;
delay  = document.querySelector ('[name="delay"]').value;
limit  = document.querySelector ('[name="limit"]').value;

    // The HTML table for writing out the simulation to screen
    tbody   = document.querySelector ('#results');
    // The self-funding date element for writing out the simulation to screen
    slffnde = document.querySelector ('#self-funding');
    // The break-even date element for writing out the simulation to screen
    brkevne = document.querySelector ('#break-even');
    // The peak investment element for writing out the simulation to screen
    investe = document.querySelector ('#invest');
    // The element for writing out year-end cumulative profit
    //yearse  = document.querySelector ('#years');

    for (i=0; i < limit; i++) {
        if (!totals[i]) {
            totals[i] = {sales : 0, newtickets : 0, charge : 0, curtickets : 0, newincome : 0, totalcharge : 0, totalincome : 0, revenue : 0, balance : 0 };
        }
        totals[i].sales = (i < campaignlength) ? sales : 0;
        if (i-delay >= 0) {
            newtickets = totals[i-delay].sales * (1-cnli/100);
        } else {
            newtickets = 0;
        }

        totals[i].newtickets = newtickets;
        totals[i].charge = totals[i].sales * charge;
        totals[i].curtickets += newtickets;
        totals[i].newincome = totals[i].curtickets * ppm;
        if (i>0) {
            totals[i].totalcharge = totals[i].charge + totals[i-1].totalcharge;
            totals[i].totalincome = totals[i].newincome + totals[i-1].totalincome;
            totals[i].revenue = totals[i].totalincome * profit / 100;
            totals[i].balance = totals[i].revenue - totals[i].totalcharge;
        } else {
            totals[i].totalcharge = totals[i].charge;
            totals[i].totalincome = totals[i].newincome;
            totals[i].revenue = totals[i].totalincome * profit / 100;
            totals[i].balance = totals[i].revenue - totals[i].totalcharge;
        }
        for (n = i+1; n < limit; n++) {
            if (!totals[n]) {
                totals[n] = {sales : 0, newtickets : 0, charge : 0, curtickets : 0, newincome : 0, totalcharge : 0, totalincome : 0, revenue : 0, balance : 0 };
            }
            if (n-i == 1) {
                newtickets = newtickets * (1 - cnl1/100);
                totals[n].curtickets += newtickets 
            }
            else if (n-1 <= 4) {
                newtickets = newtickets * (1 - cnl4/100);
                totals[n].curtickets += newtickets 
            }
            else if (n-1 <= 12) {
                newtickets = newtickets * (1 - cnl12/100);
                totals[n].curtickets += newtickets 
            }
            else {
                newtickets = newtickets * (1 - cnle/100);
                totals[n].curtickets += newtickets 
            }
            //console.log (n);
            //console.log (totals[n]);
        }
    }
    //console.log (totals);
    columns = ['sales', 'newtickets', 'charge', 'curtickets', 'newincome', 'totalcharge', 'totalincome', 'revenue', 'balance'];
    tbody.innerHTML     = '';
    var foo, invest=0;
    for (i = 0; i < limit; i++) {
        row = document.createElement ('tr');
        cell = document.createElement ('td');
        cell.textContent = i+1; // month
        row.appendChild (cell);
        for (n = 0; columns[n]; n++) {
            cell = document.createElement ('td');
            let foo = 1*(totals[i][columns[n]]);
            cell.textContent = foo.toFixed();
            row.appendChild (cell);
        }
        if (totals[i]['balance'] < invest) { // still sinking money in
            invest = totals[i]['balance'];
            row.classList.add ('self-fund-no');
        } else {
            row.classList.add ('self-fund-yes');
            if (!slffnd) {
                slffnd = i+1
            }
        }
        if (totals[i].balance<0) {
            row.classList.add ('negative');
        } else {
            if (!brkevn) {
                brkevn = i+1
            }
        }
        tbody.appendChild (row);
    }
    if (slffnd) {
        slffnde.innerHTML = '<strong>'+slffnd+' months</strong>';
    }
    if (brkevn) {
        brkevne.innerHTML = '<strong>'+brkevn+' months</strong>';
    }
    else {
        brkevne.innerHTML = 'no break-even in range';
    }
    investe.innerHTML = '<strong>'+thouSepRound(0-invest,2,' ')+'</strong>';
}


function thouSepRound (num,dp,sep=',',decsep='.') {
    var neg='',out='';
    num = num.toFixed (dp);
    if (num.indexOf('-')==0) {
        neg = '-';
        num = num.substr (1);
    }
    if (num.indexOf(decsep)>=0) {
        num = num.split (decsep);
        out = decsep + num[1];
        num = num[0];
    }
    while (num.length>3) {
        out = sep + num.substr(num.length-3,3) + out;
        num = num.substr (0,num.length-3);
    }
    out = neg + num + out;
    return out;
}


window.addEventListener (
    'DOMContentLoaded',
    function() {
        (
            function($) {
                document.querySelector('[name="calculate"]').addEventListener ('click',calculate);
            }
        ) ();
    }
);


    </script>

    <style>

section {
    margin-top: 1em;
    margin-left: 0.3em;
}
body > section {
    margin-top: 0;
    position: fixed;
    top: 0;
    left: 0;
    background-color: white;
}
#years {
    margin-top: 0;
    position: fixed;
    top: 2em;
    left: 2em;
    border-style: solid;
    border-width: 1px;
    padding: 1em;
    background-color: white;
}

label {
    display: inline-block;
    width: 20em;
}
#years label {
    display: inline-block;
    width: 12em;
}
label strong {
    font-style: italic;
}

input {
    width: 12em;
    text-align: right;
}
input[type="button"] {
    width: auto;
    text-align: center;
    margin-right: 1.2em;
}

table {
    position: absolute;
    top:  0;
    right: 0;
    border-spacing: 1em 0;
    text-align: right;
    font-family: 'courier new';
    font-size: 0.9em;
}
thead {
    position: sticky;
    top:  0;
    right: 0;
    background-color: white;
}
th {
    text-align: left;
}
td {
    padding-right: 2em;
}
td.positive {
    color: black;
}

.negative {
    color: darkred;
}
.self-fund-no {
    background-color: hsla(40,100%,97.5%,1.0);
}
.self-fund-yes {
    background-color: hsla(120,100%,97.5%,1.0);
}
.summary {
    display: inline-block;
    width: 9em;
    text-align: right;
}

    </style>

  </head>

  <body id="profit-calculator">

    <section>



      <section>
        <label>Months of sales</label>
        <input name="campaignlength" type="number" min="1" max="10000" step="1" value="12" />
      </section>

      <section>
        <label>Tickets sold per month</label>
        <input name="sales" type="number" min="0" max="10000" step="1" value="100" />
      </section>

      <section>
        <label>Charge per ticket signed-up <strong>&pound;</strong></label>
        <input name="charge" type="number" min="0.00" max="100.00" step="0.01" value="40.00" />
      </section>

      <section>
        <label>Pounds per month<strong>&pound;</strong></label>
        <input name="ppm" type="number" min="1.00" max="5.00" step="0.01" value="5.00" />
      </section>

      <section>
        <label>Months before first payment</label>
        <input name="delay" type="number" min="1" max="2" step="1" value="1" />
      </section>

      <section>
        <label>Cancellation (immediate) <strong>%</strong></label>
        <input name="cnli" type="number" min="0.0" max="10.0" step="0.1" value="6" />
      </section>

      <section>
        <label>Cancellation (after one payment) <strong>%</strong></label>
        <input name="cnl1" type="number" min="0.0" max="10.0" step="0.1" value="5" />
      </section>

      <section>
        <label>Cancellation (to month 4) <strong>%</strong></label>
        <input name="cnl4" type="number" min="0.0" max="10.0" step="0.1" value="3.5" />
      </section>

      <section>
        <label>Cancellation (to month 12) <strong>%</strong></label>
        <input name="cnl12" type="number" min="0.0" max="10.0" step="0.1" value="2.5" />
      </section>

      <section>
        <label>Cancellation (thereafter) <strong>%</strong></label>
        <input name="cnle" type="number" min="0.0" max="10.0" step="0.1" value="1.5" />
      </section>

      <section>
        <label>Return from lottery <strong>%</strong></label>
        <input name="profit" type="number" min="0" max="100" step="1" value="73" />
      </section>

      <section>
        <label>Months to display</label>
        <input name="limit" type="number" min="48" max="240" step="4" value="60" />
      </section>


      <section>
        <label>&nbsp;</label>
        <span class="summary"><input name="calculate" type="button" value="Calculate" /></span>
      </section>

      <section>
        <label>Self-funding point</label>
        <span id="self-funding" class="summary"></span>
      </section>

      <section>
        <label>Break-even point</label>
        <span id="break-even" class="summary"></span>
      </section>

      <section>
        <label>Peak investment <strong>&pound;</strong></label>
        <span id="invest" class="summary"></span>
      </section>

      <!--section>
        <details>
          <summary>Yearly balances</summary>
          <section id="years" onclick="this.parentElement.open=false"></section>
        </details>
      </section-->

    </section>

    <table>
      <thead>
        <tr>
            <th>Month</th>
            <th>Sales</th>
            <th>New Tickets</th>
            <th>Charge</th>
            <th>Tickets in play</th>
            <th>New Income</th>
            <th>Total Charge</th>
            <th>Total Income</th>
            <th>Revenue</th>
            <th>Balance</th>
        </Tr>
      </thead>
      <tbody id="results">
      </tbody>
      <tfoot>
        <td colspan="9">&nbsp;</td>
      </tfoot>
    </table>

  </body>

</html>


